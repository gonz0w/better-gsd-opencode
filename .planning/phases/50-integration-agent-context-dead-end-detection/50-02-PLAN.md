---
phase: 50-integration-agent-context-dead-end-detection
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - src/commands/init.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [INTEG-02, INTEG-04]

must_haves:
  truths:
    - "Init execute-phase output includes previous_attempts section drawn from trajectory journal"
    - "Previous attempts context is capped at ~500 tokens to avoid context bloat"
    - "Failed attempt lessons are formatted as 'what NOT to do' context with specific reasons"
    - "When no trajectory history exists, previous_attempts is null (silent, no noise)"
  artifacts:
    - path: "src/commands/init.js"
      provides: "previous_attempts field in cmdInitExecutePhase output"
      contains: "previous_attempts"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for dead-end detection, init integration, and scope validation"
  key_links:
    - from: "src/commands/init.js"
      to: "src/commands/trajectory.js"
      via: "require('./trajectory').queryDeadEnds"
      pattern: "queryDeadEnds"
    - from: "src/commands/init.js"
      to: ".planning/memory/trajectory.json"
      via: "queryDeadEnds reads journal"
      pattern: "previous_attempts"
---

<objective>
Integrate dead-end detection into init execute-phase and add comprehensive test suite.

Purpose: When agents start executing a phase, they automatically receive context about past failed approaches — preventing dead-end re-exploration without manual lookup. Tests ensure all integration points work correctly.
Output: Enhanced init execute-phase with previous_attempts, 10-15 new tests covering INTEG-01 through INTEG-04.
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-integration-agent-context-dead-end-detection/50-01-SUMMARY.md
@src/commands/init.js
@src/commands/trajectory.js
@bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate previous_attempts into init execute-phase</name>
  <files>src/commands/init.js, bin/gsd-tools.cjs</files>
  <action>
In src/commands/init.js, in the `cmdInitExecutePhase` function:

1. Add lazy import for trajectory module near the trajectory integration section (after existing advisory blocks like intent_drift and env_summary):
```
// Trajectory dead-end context — previous attempts for this phase
try {
  const { queryDeadEnds, formatDeadEndContext } = require('./trajectory');
  const deadEnds = queryDeadEnds(cwd, { scope: 'phase' });
  if (deadEnds.length > 0) {
    result.previous_attempts = {
      count: deadEnds.length,
      context: formatDeadEndContext(deadEnds, 500),
      entries: deadEnds.slice(0, 5).map(de => ({
        name: de.checkpoint_name,
        attempt: de.attempt,
        reason: de.reason,
        timestamp: de.timestamp,
      })),
    };
  } else {
    result.previous_attempts = null;
  }
} catch (e) {
  debugLog('init.executePhase', 'trajectory dead-end context failed (non-blocking)', e);
  result.previous_attempts = null;
}
```

2. Add `previous_attempts` to the initial result object declaration (set to `null` alongside intent_drift).

3. In the compact mode block (the `if (global._gsdCompactMode)` section), add `previous_attempts: result.previous_attempts` to compactResult.

4. In the trim null section at bottom, add: `if (result.previous_attempts === null) delete result.previous_attempts;`

This follows the exact same advisory pattern used by intent_drift, env_summary, and codebase_stats — never crash, never block, null when absent.

Run `npm run build` to rebuild.
  </action>
  <verify>npm run build && node bin/gsd-tools.cjs init execute-phase 50 2>&1 | node -e "process.stdin.resume(); let d=''; process.stdin.on('data',c=>d+=c); process.stdin.on('end',()=>{const j=JSON.parse(d); console.log('has previous_attempts key:', 'previous_attempts' in j || j.previous_attempts === undefined ? 'null/absent (correct - no pivots)' : 'unexpected')})"</verify>
  <done>Init execute-phase output includes previous_attempts field (null when no trajectory history, populated with dead-end context when pivots exist). Compact mode includes the field. Null values are trimmed from verbose output.</done>
</task>

<task type="auto">
  <name>Task 2: Add integration test suite</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add a new test section "// ─── Trajectory Integration Tests ──────" in bin/gsd-tools.test.cjs after the existing trajectory choose tests.

Tests to add (use existing test patterns — execFileSync against bin/gsd-tools.cjs in tmpDir with writeTrajectoryEntries helper from choose tests):

**INTEG-01: Dead-end detection (4 tests)**
1. "trajectory dead-ends returns empty when no journal exists" — run in clean tmpDir, expect `{ dead_ends: [], count: 0 }`
2. "trajectory dead-ends returns pivot entries as dead ends" — write trajectory.json with 2 pivot entries + 1 checkpoint entry, run dead-ends, expect count: 2, only pivot entries returned
3. "trajectory dead-ends filters by scope" — write pivots with scope 'phase' and 'task', run with `--scope phase`, expect only phase-scoped pivots
4. "trajectory dead-ends filters by name" — write pivots with different names, run with `--name X`, expect only matching pivots

**INTEG-02: Init integration (2 tests)**
5. "init execute-phase includes previous_attempts when pivots exist" — write trajectory.json with pivot entries, create minimal .planning/ structure, run `init execute-phase`, verify `previous_attempts` field has count > 0 and non-empty context string
6. "init execute-phase omits previous_attempts when no pivots" — run in clean project dir, verify previous_attempts is null or absent

**INTEG-03: Context formatting (2 tests)**
7. "dead-end context formatted as what-NOT-to-do" — write 3 pivots with reasons, run dead-ends, verify context string contains each reason
8. "dead-end context respects token cap" — write 20 pivots with long reasons, run with `--token-cap 100`, verify context is truncated with "... and N more" message

**INTEG-04: Scope validation (3 tests)**
9. "trajectory checkpoint rejects invalid scope" — run with `--scope banana`, expect error containing "Invalid scope"
10. "trajectory pivot rejects invalid scope" — run with `--scope foo`, expect error containing "Invalid scope"
11. "trajectory dead-ends accepts all valid scopes" — run with --scope task, --scope plan, --scope phase in sequence, all should succeed (not error)

Use the existing test helper patterns:
- `initGitForChoose(tmpDir)` / `initMinimalProject(tmpDir)` for setup
- `writeTrajectoryEntries(tmpDir, entries)` for journal creation
- `execFileSync(process.execPath, [BIN, ...args], { cwd: tmpDir })` for running commands
- `assert.strictEqual`, `assert.ok`, `JSON.parse(stdout)` for assertions
- Each test in a try/catch that increments pass/fail counters
  </action>
  <verify>npm test 2>&1 | tail -10 (expect all tests pass including new integration tests, total should be ~762+)</verify>
  <done>11+ new tests covering all INTEG requirements pass. Total test suite passes with 0 failures. Build within 1050KB budget.</done>
</task>

</tasks>

<verification>
- `node bin/gsd-tools.cjs init execute-phase 50 --compact` includes previous_attempts in output (null or populated)
- All 11+ new tests pass alongside existing 751 tests
- `npm test` shows 0 failures
- `npm run build` succeeds within 1050KB budget
- Dead-end detection → init integration → agent context pipeline is end-to-end functional
</verification>

<success_criteria>
Agents receiving init execute-phase context automatically see past failed approaches as "what NOT to do" warnings. All four INTEG requirements have test coverage. Zero regressions in existing test suite.
</success_criteria>

<output>
After completion, create `.planning/phases/50-integration-agent-context-dead-end-detection/50-02-SUMMARY.md`
</output>
