---
phase: 47-pivot-selective-rewind-attempt-archival
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/trajectory.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.cjs
autonomous: true
requirements: [PIVOT-01, PIVOT-02, PIVOT-03]

must_haves:
  truths:
    - "User can run `trajectory pivot <checkpoint>` and source code rewinds to checkpoint state while .planning/ is preserved"
    - "Pivot refuses to run on dirty working tree with clear error and stash guidance"
    - "Pivot requires structured reason (what failed, why, signals) persisted in journal as abandoned entry"
    - "Current work is auto-checkpointed as abandoned attempt before rewind — no work lost"
    - "Archived branch created at archived/trajectory/<scope>/<name>/attempt-N"
  artifacts:
    - path: "src/commands/trajectory.js"
      provides: "cmdTrajectoryPivot function with reason capture, auto-checkpoint, selective rewind, branch archival"
      exports: ["cmdTrajectoryPivot"]
    - path: "src/router.js"
      provides: "trajectory pivot subcommand routing"
      contains: "case 'pivot'"
    - path: "src/lib/constants.js"
      provides: "trajectory pivot help text"
      contains: "pivot"
  key_links:
    - from: "src/commands/trajectory.js"
      to: "src/lib/git.js"
      via: "selectiveRewind() for code rewind"
      pattern: "selectiveRewind"
    - from: "src/commands/trajectory.js"
      to: ".planning/memory/trajectory.json"
      via: "journal entry write for abandoned checkpoint"
      pattern: "trajectory\\.json"
    - from: "src/router.js"
      to: "src/commands/trajectory.js"
      via: "lazyTrajectory().cmdTrajectoryPivot"
      pattern: "cmdTrajectoryPivot"
---

<objective>
Implement the `trajectory pivot <checkpoint>` command that lets users abandon a failing approach, auto-save current work as an abandoned attempt, capture structured reasoning, and rewind source code to a prior checkpoint.

Purpose: Core pivot workflow — the heart of trajectory engineering's "try, fail, learn, rewind" loop
Output: Working `trajectory pivot` command with reason capture, auto-checkpoint, selective rewind, and branch archival
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-pivot-selective-rewind-attempt-archival/47-CONTEXT.md
@src/commands/trajectory.js
@src/lib/git.js
@src/router.js
@src/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement trajectory pivot command with reason capture, auto-checkpoint, and selective rewind</name>
  <files>src/commands/trajectory.js</files>
  <action>
Add `cmdTrajectoryPivot(cwd, args, raw)` function to `src/commands/trajectory.js`. The function implements the full pivot workflow:

**Arg parsing:**
- `args[0]` is 'pivot', positional `args[1+]` is the checkpoint name
- `--scope <scope>` flag (default: 'phase')
- `--reason <text>` flag for non-interactive/agent use (bypasses interactive prompts)
- `--attempt <N>` flag to pick a specific attempt (default: most recent)
- `--stash` flag to auto-stash dirty working tree (when offered)

**Step 1 — Dirty working tree check (PIVOT-01 prerequisite):**
- Run `execGit(cwd, ['status', '--porcelain'])` and filter out `.planning/` paths (same pattern as checkpoint command)
- If dirty files exist: call `error('Uncommitted changes detected. Commit or stash before pivoting.\nTo auto-stash: trajectory pivot <checkpoint> --stash')` 
- If `--stash` flag is present and dirty: run `execGit(cwd, ['stash', 'push', '-m', 'gsd-pivot-auto-stash'])` and set `stashUsed = true`

**Step 2 — Resolve checkpoint (find target):**
- Read `.planning/memory/trajectory.json` — parse entries array
- Filter entries where `e.category === 'checkpoint'` AND `e.checkpoint_name === name` AND `e.scope === scope` AND NOT `e.tags.includes('abandoned')`
- If no matching entries: call `error('Checkpoint "' + name + '" not found (scope: ' + scope + ').\nAvailable checkpoints:\n' + availableList)` where `availableList` is formatted from all unique `checkpoint_name` values grouped by scope
- If `--attempt N` specified: find entry with `e.attempt === N`, error if not found
- Otherwise: pick the entry with the highest attempt number (most recent)
- Store as `targetEntry` with its `git_ref` and `branch`

**Step 3 — Capture structured reason (PIVOT-02):**
- If `--reason` flag provided: use that string directly as `reasonText`
- If no `--reason` flag: since this is a CLI tool invoked by agents, we need the reason. Call `error('Reason required. Use --reason "what failed, why, what signals" to record why this approach is being abandoned.')` — interactive TTY prompts are not feasible in this CLI architecture (gsd-tools is invoked via execFileSync, not interactive). The `--reason` flag IS the capture mechanism.
- Parse reason into structured object: `{ text: reasonText }` — keep it simple, the full text captures what/why/signals as a single narrative

**Step 4 — Auto-checkpoint current work as abandoned (PIVOT-03):**
- Get current HEAD SHA via `execGit(cwd, ['rev-parse', 'HEAD'])`
- Count existing checkpoint entries for same scope+name to determine next attempt number
- Create abandoned branch: `archived/trajectory/<scope>/<name>/attempt-<N>`
  - Use `execGit(cwd, ['branch', branchName])` (ref-only, no checkout)
- Generate new journal entry ID (same pattern as checkpoint: `tj-` + random hex with collision check)
- Write journal entry to entries array:
  ```
  {
    id, timestamp: new Date().toISOString(),
    category: 'checkpoint',
    text: `Abandoned: ${name} (attempt ${attempt})`,
    scope, checkpoint_name: name, attempt,
    branch: 'archived/trajectory/<scope>/<name>/attempt-<N>',
    git_ref: currentHeadSha,
    description: null,
    metrics: null,  // Skip full metrics per CONTEXT.md decision — speed over data
    reason: { text: reasonText },
    tags: ['checkpoint', 'abandoned']
  }
  ```

**Step 5 — Selective rewind to checkpoint (PIVOT-01):**
- Import and call `selectiveRewind(cwd, { ref: targetEntry.git_ref, confirm: true })` from `../lib/git`
- Check result: if `result.error`, call `error('Rewind failed: ' + result.error)` (pop stash first if stashUsed)
- If stash was used, pop stash after rewind: `execGit(cwd, ['stash', 'pop'])`

**Step 6 — Write journal and output:**
- Write updated entries array to trajectory.json
- Call `output()` with minimal result per CONTEXT.md decision:
  ```
  {
    pivoted: true,
    checkpoint: name,
    target_ref: targetEntry.git_ref,
    abandoned_branch: abandonedBranchName,
    files_rewound: result.files_changed,
    stash_used: stashUsed
  }
  ```
- Add TTY formatter `formatPivotResult` that outputs: `"Pivoted to <checkpoint>. Abandoned attempt archived as <branch>."`

**Export:** Add `cmdTrajectoryPivot` to `module.exports`.

**Important implementation notes:**
- Reuse `selectiveRewind()` from `../lib/git` — do NOT reimplement checkout logic
- Reuse existing `output, error, debugLog` from `../lib/output`
- Reuse existing `execGit` from `../lib/git`
- Follow existing code style in trajectory.js (compact, same import pattern)
- Reuse `NAME_RE` for checkpoint name validation
- Follow the `banner`, `summaryLine`, `actionHint` pattern from format.js for TTY output
  </action>
  <verify>Run `npm run build` — build succeeds within bundle budget. Run `node bin/gsd-tools.cjs trajectory pivot --help` — shows help text. Run `node bin/gsd-tools.cjs trajectory pivot nonexistent --reason "test"` — shows checkpoint not found error.</verify>
  <done>The `trajectory pivot` command exists, parses all flags correctly, validates dirty tree, resolves checkpoints from journal, creates abandoned branch, writes abandoned journal entry with reason, calls selectiveRewind for code rewind, and outputs minimal result.</done>
</task>

<task type="auto">
  <name>Task 2: Add router case and help text for trajectory pivot</name>
  <files>src/router.js, src/lib/constants.js, bin/gsd-tools.cjs</files>
  <action>
**Router (src/router.js):**
In the `case 'trajectory':` switch block (around line 926-932), add a new case for 'pivot':
```
case 'pivot': lazyTrajectory().cmdTrajectoryPivot(cwd, args.slice(1), raw); break;
```
Update the default error message to include 'pivot' in the available subcommands list.

**Constants (src/lib/constants.js):**
Update the `'trajectory'` help text in `COMMAND_HELP` to include the pivot subcommand:
```
  pivot <checkpoint>   Abandon current approach, rewind to checkpoint
    --scope <scope>       Scope level (default: phase)
    --reason <text>       Why this approach is being abandoned (required)
    --attempt <N>         Target specific attempt (default: most recent)
    --stash               Auto-stash dirty working tree before pivot
```
Add a separate `'trajectory pivot'` compound help key with detailed usage, examples:
```
Usage: gsd-tools trajectory pivot <checkpoint> --reason "what failed and why"

Abandon current approach with recorded reasoning and rewind to checkpoint.
Auto-checkpoints current work as abandoned attempt before rewinding.

Arguments:
  checkpoint          Name of checkpoint to rewind to

Options:
  --scope <scope>     Scope level (default: phase)
  --reason <text>     Structured reason for abandoning (required)
  --attempt <N>       Target specific attempt number (default: most recent)
  --stash             Auto-stash dirty working tree before pivot

Output: { pivoted, checkpoint, target_ref, abandoned_branch, files_rewound, stash_used }

Examples:
  gsd-tools trajectory pivot explore-auth --reason "JWT approach too complex, session-based simpler"
  gsd-tools trajectory pivot try-redis --scope task --reason "Redis overkill for this cache size"
  gsd-tools trajectory pivot my-feature --attempt 2 --reason "Attempt 2 had better foundation"
```

**Build:**
Run `npm run build` to rebuild `bin/gsd-tools.cjs` with the new command.
  </action>
  <verify>Run `npm run build` — succeeds within budget. Run `node bin/gsd-tools.cjs trajectory pivot --help` — shows detailed pivot help. Run `node bin/gsd-tools.cjs trajectory --help` — shows pivot in subcommand list. Run `node bin/gsd-tools.cjs trajectory badcmd` — error includes 'pivot' in available list.</verify>
  <done>Router routes `trajectory pivot` to `cmdTrajectoryPivot`. Help text documents all flags and usage. Bundle rebuilt. Unknown trajectory subcommand error lists pivot as available.</done>
</task>

</tasks>

<verification>
- `npm run build` passes within 1050KB budget
- `node bin/gsd-tools.cjs trajectory pivot --help` shows usage
- `node bin/gsd-tools.cjs trajectory --help` lists pivot subcommand
- `node bin/gsd-tools.cjs trajectory pivot nonexistent --reason "test"` produces "not found" error with available checkpoints
</verification>

<success_criteria>
- trajectory pivot command exists and routes correctly
- Dirty tree blocked with clear error message and --stash guidance
- Checkpoint lookup resolves from trajectory journal with scope+name filtering
- Auto-checkpoint creates abandoned branch with journal entry containing reason
- selectiveRewind called for code rewind preserving .planning/
- Minimal output: "Pivoted to <checkpoint>. Abandoned attempt archived as <branch>."
</success_criteria>

<output>
After completion, create `.planning/phases/47-pivot-selective-rewind-attempt-archival/47-01-SUMMARY.md`
</output>
