---
phase: 47-pivot-selective-rewind-attempt-archival
plan: 02
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - src/lib/recovery/stuck-detector.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements: [PIVOT-04]

must_haves:
  truths:
    - "Stuck-detector suggests pivoting to last checkpoint when stuck detection fires (3 failures)"
    - "Suggestion appears even when no checkpoint exists (suggests creating one first)"
    - "Pivot command passes all tests: dirty tree rejection, checkpoint resolution, auto-checkpoint abandoned, selective rewind, reason persistence, branch archival"
  artifacts:
    - path: "src/lib/recovery/stuck-detector.js"
      provides: "Trajectory pivot suggestion in recovery alternatives"
      contains: "pivot"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Comprehensive pivot + stuck-detector tests"
      contains: "trajectory pivot"
  key_links:
    - from: "src/lib/recovery/stuck-detector.js"
      to: "trajectory pivot"
      via: "advisory message in _generateAlternatives"
      pattern: "trajectory pivot"
    - from: "bin/gsd-tools.test.cjs"
      to: "src/commands/trajectory.js"
      via: "runGsdTools('trajectory pivot ...')"
      pattern: "trajectory pivot"
---

<objective>
Integrate stuck-detector pivot suggestion and add comprehensive tests for all pivot functionality.

Purpose: Complete PIVOT-04 (stuck-detector integration) and validate all PIVOT-01 through PIVOT-03 requirements with tests
Output: Stuck-detector suggests pivoting after 3 failures; comprehensive test coverage for pivot command
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-pivot-selective-rewind-attempt-archival/47-CONTEXT.md
@.planning/phases/47-pivot-selective-rewind-attempt-archival/47-01-SUMMARY.md
@src/lib/recovery/stuck-detector.js
@src/commands/trajectory.js
@bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trajectory pivot suggestion to stuck-detector recovery alternatives</name>
  <files>src/lib/recovery/stuck-detector.js, bin/gsd-tools.cjs</files>
  <action>
Extend the `_generateAlternatives(history)` method in the `StuckDetector` class to include a trajectory pivot suggestion. Per CONTEXT.md: advisory message only, always shown when stuck (3 failures), simple hint format.

**In `_generateAlternatives(history)` method:**
Add a new alternative entry at the TOP of the alternatives array (before "Take a break"):
```javascript
{
  approach: 'Pivot to checkpoint',
  description: 'Consider pivoting to a prior checkpoint: trajectory pivot <checkpoint-name> --reason "..."'
}
```

This is always added (not conditional on checkpoint existence) per CONTEXT.md decision: "Suggestion always appears when stuck detection fires (3 failures), even if no checkpoint exists (suggest creating one first)."

The wording serves both cases:
- If checkpoints exist: user can directly run the command
- If no checkpoints exist: the command will error with "Available checkpoints: (none)" and the user learns to create one

**Build:**
Run `npm run build` to rebuild bundle.
  </action>
  <verify>Run `npm run build` — succeeds. Verify the `_generateAlternatives` method includes the pivot suggestion by reading the updated file.</verify>
  <done>Stuck-detector includes "Pivot to checkpoint" as the first recovery suggestion when stuck detection fires, with the `trajectory pivot` command hint.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for trajectory pivot and stuck-detector integration</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add two new `describe` blocks to the test file following existing trajectory test patterns.

**`describe('trajectory pivot', () => { ... })`** — add after the trajectory list tests:

All tests use the standard test pattern: create tmpDir with git init, add initial commit, set up `.planning/memory/trajectory.json` with checkpoint entries, and create corresponding git branches as needed.

**Test 1: pivot rewrites to checkpoint state (PIVOT-01)**
- Set up: create a checkpoint entry in trajectory.json with a known git_ref. Create a git branch matching the checkpoint. Make a new commit after the checkpoint (add a file `src/new-feature.js`).
- Run: `trajectory pivot my-checkpoint --reason "approach failed"`
- Assert: output JSON has `pivoted: true`, `checkpoint: 'my-checkpoint'`, `abandoned_branch` starts with `archived/trajectory/`
- Assert: `src/new-feature.js` no longer exists in working tree (rewind worked)
- Assert: `.planning/memory/trajectory.json` still exists (preserved by selective rewind)

**Test 2: pivot refuses on dirty working tree (PIVOT-01 prerequisite)**
- Set up: create checkpoint entry and branch. Write an uncommitted file `src/dirty.js`.
- Run: `trajectory pivot my-checkpoint --reason "test"`
- Assert: exit code non-zero, stderr contains 'Uncommitted changes' or 'stash'

**Test 3: pivot with --stash on dirty tree succeeds**
- Set up: create checkpoint entry and branch. Create a post-checkpoint commit. Write uncommitted file `src/dirty.js`.
- Run: `trajectory pivot my-checkpoint --reason "test" --stash`
- Assert: output JSON has `pivoted: true`, `stash_used: true`

**Test 4: pivot requires --reason flag**
- Run: `trajectory pivot my-checkpoint` (no --reason)
- Assert: exit code non-zero, stderr contains 'Reason required' or '--reason'

**Test 5: pivot on nonexistent checkpoint shows error with available list**
- Set up: create a checkpoint entry for 'existing-cp'
- Run: `trajectory pivot nonexistent --reason "test"`
- Assert: exit code non-zero, stderr contains 'not found'

**Test 6: auto-checkpoint creates abandoned journal entry (PIVOT-03)**
- Set up: create checkpoint entry and branch. Make post-checkpoint commit.
- Run: `trajectory pivot my-checkpoint --reason "JWT approach too complex"`
- Assert: read trajectory.json — find entry with `tags` containing both 'checkpoint' and 'abandoned'
- Assert: abandoned entry has `reason.text` containing "JWT approach too complex"
- Assert: abandoned entry `branch` starts with `archived/trajectory/`

**Test 7: archived branch is created for abandoned attempt**
- Set up: same as test 6
- After pivot: run `git branch --list 'archived/*'` and assert the abandoned branch exists

**Test 8: pivot with --scope flag**
- Set up: create checkpoint with scope 'task'
- Run: `trajectory pivot my-checkpoint --scope task --reason "test"`
- Assert: output JSON has `pivoted: true`

**Test 9: pivot with --attempt flag picks specific attempt**
- Set up: create two checkpoint entries for same name (attempt 1 and attempt 2) with different git refs
- Run: `trajectory pivot my-checkpoint --attempt 1 --reason "reverting to attempt 1"`
- Assert: `target_ref` matches attempt 1's git_ref

**Test 10: .planning/ directory preserved after pivot (PIVOT-01)**
- Set up: create checkpoint, make post-checkpoint commit, create `.planning/phases/47-test/test.md`
- Run pivot
- Assert: `.planning/phases/47-test/test.md` still exists after rewind

**`describe('stuck-detector trajectory suggestion (PIVOT-04)', () => { ... })`:**

**Test 11: stuck-detector includes pivot suggestion in alternatives**
- Import `StuckDetector` or `createStuckDetector` from the built bundle
- Create detector instance, record 3+ failed attempts for same task
- Call `getStatus(taskId)` — assert `isStuck: true`
- Verify `_generateAlternatives` output includes an entry with approach containing 'pivot' or 'Pivot to checkpoint'

**Test 12: pivot suggestion appears even with generic errors**
- Create detector, record 3 identical 'timeout' errors
- Verify alternatives include trajectory pivot suggestion

Each test should clean up its tmpDir. Follow existing test patterns exactly — use `runGsdTools()`, `execSync()`, `assert.strictEqual()`, `assert.ok()`, and `JSON.parse()` as done in trajectory checkpoint/list tests.

**Build:**
Run `npm run build` to rebuild bundle with updated stuck-detector.
  </action>
  <verify>Run `npm test` — all tests pass including new trajectory pivot and stuck-detector tests. Run `npm test 2>&1 | grep -E '(# tests|# pass|# fail)'` to confirm test count increased by ~12 and 0 failures.</verify>
  <done>12 new tests covering: pivot rewind (PIVOT-01), dirty tree rejection, --stash flag, --reason requirement (PIVOT-02), checkpoint not found, auto-checkpoint abandoned entry (PIVOT-03), archived branch creation, --scope flag, --attempt flag, .planning/ preservation, stuck-detector pivot suggestion (PIVOT-04), and generic error suggestion. All tests pass with zero regressions.</done>
</task>

</tasks>

<verification>
- `npm test` passes with zero failures
- Test count increased by ~12 from baseline
- Tests cover all 4 PIVOT requirements explicitly
- Stuck-detector alternatives include "Pivot to checkpoint" suggestion
- `npm run build` succeeds within bundle budget
</verification>

<success_criteria>
- Stuck-detector suggests pivoting after 3 failures (PIVOT-04)
- 12+ new tests covering all pivot edge cases
- Zero test regressions from pre-existing 692+ tests
- All PIVOT-01 through PIVOT-04 requirements exercised by tests
</success_criteria>

<output>
After completion, create `.planning/phases/47-pivot-selective-rewind-attempt-archival/47-02-SUMMARY.md`
</output>
