# Milestone v7.1: Trajectory Engineering

**Status:** ✅ SHIPPED 2026-03-02
**Phases:** 45-50
**Total Plans:** 12

## Overview

Structured exploration system — checkpoint, pivot, compare, and choose between multiple approaches at any workflow level, with a decision journal consumable by both agents and humans. Enables agents to learn from past exploration failures and never re-explore known dead ends.

## Phases

### Phase 45: Foundation — Decision Journal & State Coherence

**Goal**: Trajectory data has a persistent, session-portable home and code rewinds never corrupt planning state
**Depends on**: Nothing (first phase of v7.1)
**Plans**: 2 plans

Plans:
- [x] 45-01-PLAN.md — Trajectories memory store with structured journal entries, crypto IDs, filtering
- [x] 45-02-PLAN.md — Selective git rewind with protected-path denylist and trajectory branch namespace

**Details:**
- Added `trajectories` sacred memory store with auto-generated unique IDs (tj-XXXXXX format)
- Category/phase/date-range/tag filtering for trajectory reads
- `selectiveRewind()` function with protected-path denylist and auto-stash
- `trajectoryBranch()` function with `gsd/trajectory` namespace and collision detection
- Bumped bundle budget from 1000KB to 1050KB for v7.1 feature growth

### Phase 46: Checkpoint — Snapshot & Metrics Collection

**Goal**: Users can name and save points in their exploration with automatic metrics capture
**Depends on**: Phase 45
**Plans**: 2 plans

Plans:
- [x] 46-01-PLAN.md — Checkpoint command with auto-metrics and branch creation
- [x] 46-02-PLAN.md — List command with formatted output

**Details:**
- `trajectory checkpoint` command creates named snapshots with git branch at `trajectory/<scope>/<name>/attempt-N`
- Auto-collects test count, LOC delta, and cyclomatic complexity at checkpoint time
- `trajectory list` with filtering (--scope, --name, --limit) and formatted TTY output
- Fault-tolerant metrics collection — partial metrics if any collector fails
- Branch ref-only creation (no checkout) to preserve working tree

### Phase 47: Pivot — Selective Rewind & Attempt Archival

**Goal**: Users can abandon a failing approach with full reasoning capture and safely rewind to a prior checkpoint
**Depends on**: Phase 46
**Plans**: 2 plans

Plans:
- [x] 47-01-PLAN.md — Pivot command with reason capture, auto-checkpoint, and selective rewind
- [x] 47-02-PLAN.md — Stuck-detector integration and comprehensive pivot tests

**Details:**
- `trajectory pivot` command rewinds code to checkpoint state while preserving `.planning/`
- Reason capture via `--reason` flag with structured journal entry (what failed, why, signals)
- Auto-checkpoints current state as "abandoned" before rewind — no work lost silently
- Stuck-detector suggests pivot as first alternative after 3 failures
- Fixed `selectiveRewind` to handle D-status files (added after checkpoint) by deletion

### Phase 48: Compare — Multi-Attempt Metrics Aggregation

**Goal**: Users can see data-driven comparison of all attempts to make informed exploration decisions
**Depends on**: Phase 47
**Plans**: 2 plans

Plans:
- [x] 48-01-PLAN.md — Compare command implementation with color-coded TTY output
- [x] 48-02-PLAN.md — Comprehensive compare test suite validating all COMP requirements

**Details:**
- `trajectory compare` shows test results, LOC delta, and complexity per attempt side-by-side
- Aggregated matrix identifying best attempt per metric (green=best, red=worst)
- Best/worst identification with direction rules (higher/lower is better) and skip-if-tied
- JSON fallback when piped (non-TTY)
- 11 tests covering all COMP-01 through COMP-05 requirements

### Phase 49: Choose — Merge Winner & Cleanup

**Goal**: Users can select the winning approach, merge it back, and have all exploration artifacts cleanly archived
**Depends on**: Phase 48
**Plans**: 2 plans

Plans:
- [x] 49-01-PLAN.md — Choose command implementation (merge, tag archival, branch cleanup, journal)
- [x] 49-02-PLAN.md — Comprehensive choose test suite validating all CHOOSE requirements

**Details:**
- `trajectory choose <attempt-N>` merges winning attempt via `--no-ff` to preserve branch lineage
- Non-chosen attempts archived as lightweight tags (`archived/trajectory/<scope>/<name>/attempt-N`)
- All trajectory branches deleted after merge — tags preserve history
- Journal records final choice with rationale, completing trajectory lifecycle
- 12 tests covering CHOOSE-01 through CHOOSE-03

### Phase 50: Integration — Agent Context & Dead-End Detection

**Goal**: Agents automatically learn from past exploration failures and never re-explore known dead ends
**Depends on**: Phase 49
**Plans**: 2 plans

Plans:
- [x] 50-01-PLAN.md — Dead-end detection library, scope validation, trajectory dead-ends command
- [x] 50-02-PLAN.md — Init execute-phase integration and comprehensive test suite

**Details:**
- `queryDeadEnds()` API filters by both 'pivot' category and 'abandoned' tag
- `formatDeadEndContext()` generates token-capped (500 tokens) "what NOT to do" context
- `previous_attempts` field injected into init execute-phase output (advisory pattern — never crash, null when absent)
- Scope validation restricts trajectory commands to task/plan/phase via `VALID_TRAJECTORY_SCOPES`
- 11 integration tests covering INTEG-01 through INTEG-04

---

## Milestone Summary

**Key Decisions:**
- Used crypto.randomBytes(3) for trajectory IDs with collision detection
- Denylist approach for protected paths in selective rewind (safer default)
- Reason capture via --reason flag (not interactive prompts) since gsd-tools runs via execFileSync
- Abandoned branches use archived/trajectory/<scope>/<name>/attempt-N namespace
- Used --no-ff merge for trajectory choose to preserve branch lineage
- Advisory integration pattern for dead-end context (never crash, null when absent)
- Scope validation restricts to task/plan/phase levels

**Issues Resolved:**
- Selective rewind edge case: files added after checkpoint (D-status) now handled by deletion
- Consecutive checkpoints work without committing .planning/ metadata
- Stuck-detector wired to suggest pivot as first alternative

**Issues Deferred:**
- Trajectory analytics (success rate tracking, attempts-to-resolution metric, common pivot signals)
- Advanced exploration (trajectory templates, cross-project pattern sharing)

**Technical Debt Incurred:**
- Bundle grew from 1000KB to 1058KB (budget bumped to 1050KB, slightly over)

---

_For current project status, see .planning/ROADMAP.md_
